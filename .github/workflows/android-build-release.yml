name: Android Build and Release

on:
  workflow_dispatch:
    inputs:
      release_notes:
        description: '发布注释（可选）'
        required: false
        default: ''
        type: string
  push:
    tags:
      - 'v*.*.*'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write

jobs:
  build:
    name: Build Release APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper/
          key: gradle-cache-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-cache-${{ runner.os }}-

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Decode keystore
        shell: bash
        env:
          RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        run: |
          if [ -n "${RELEASE_KEYSTORE_BASE64:-}" ]; then
            mkdir -p app/release
            echo "$RELEASE_KEYSTORE_BASE64" | base64 --decode > "$PWD/app/release/release-keystore.jks"
            chmod 600 "$PWD/app/release/release-keystore.jks"
          fi

      - name: Build Release APK
        env:
          RELEASE_KEYSTORE_KEY: ${{ secrets.RELEASE_KEYSTORE_KEY }}
          RELEASE_KEYSTORE_SUBKEY: ${{ secrets.RELEASE_KEYSTORE_SUBKEY }}
        run: |
          set -euo pipefail
          STORE_FILE="$PWD/app/release/release-keystore.jks"
          SIGNING_PROPS=""
          if [ -f "$STORE_FILE" ] && [ -n "${RELEASE_KEYSTORE_KEY:-}" ] && [ -n "${RELEASE_KEYSTORE_SUBKEY:-}" ]; then
            # 使用在 app/build.gradle.kts 中配置的属性名
            SIGNING_PROPS="-PRELEASE_STORE_FILE=$STORE_FILE -PRELEASE_STORE_PASSWORD=${RELEASE_KEYSTORE_KEY} -PRELEASE_KEY_ALIAS=release -PRELEASE_KEY_PASSWORD=${RELEASE_KEYSTORE_SUBKEY}"
          fi

          ./gradlew assembleRelease $SIGNING_PROPS

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-release
          path: app/build/outputs/apk/release/*.apk
          retention-days: 1

  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: apk-release
          path: release_artifacts

      - name: Compute release metadata
        id: meta
        env:
          RELEASE_NOTES: ${{ github.event.inputs.release_notes }}
        run: |
          set -euo pipefail
          # 从 build.gradle.kts 提取版本号
          VERSION=$(grep "versionName =" app/build.gradle.kts | head -n 1 | awk -F'"' '{print $2}')
          VERSION=${VERSION:-"build-${GITHUB_RUN_ID}"}
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="v${VERSION}-${GITHUB_RUN_NUMBER}"
          else
            TAG_NAME="${{ github.ref_name }}"
          fi

          if [ -n "${RELEASE_NOTES:-}" ]; then
            BODY="$RELEASE_NOTES"
          else
            BODY=$(git log --pretty=format:"%h - %s" -n 20)
          fi

          echo "tag_name=${TAG_NAME}" >> "$GITHUB_OUTPUT"
          echo "release_name=${VERSION}" >> "$GITHUB_OUTPUT"
          {
            echo 'body<<EOF'
            echo "$BODY"
            echo EOF
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag_name }}
          name: ${{ steps.meta.outputs.release_name }}
          body: ${{ steps.meta.outputs.body }}
          files: release_artifacts/*.apk
